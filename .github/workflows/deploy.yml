---
- name: Déploiement Complet Petshop + SOC Security (Hydra Detection)
  hosts: all
  become: yes
  vars:
    docker_username: "{{ lookup('env', 'DOCKER_USERNAME') | default('ndeyeawambow') }}"

  tasks:
    # --- 1. PRÉPARATION DES RÉPERTOIRES & CONFIG ---
    - name: Créer les dossiers de configuration
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/prometheus
        - /etc/promtail # Pour la collecte des logs (SOC)

    - name: Configuration Prometheus (IP Passerelle Docker)
      copy:
        dest: /etc/prometheus/prometheus.yml
        content: |
          global:
            scrape_interval: 5s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
            - job_name: 'node_exporter'
              static_configs:
                - targets: ['172.17.0.1:9100']
            - job_name: 'cadvisor'
              static_configs:
                - targets: ['172.17.0.1:8080']

    # --- 2. DÉPLOIEMENT DE L'APPLICATION ---
    - name: Lancer Petshop App
      community.docker.docker_container:
        name: petshop-app
        image: "{{ docker_username }}/petshop:latest"
        state: started
        restart_policy: always
        published_ports: ["80:80"]

    # --- 3. DÉPLOIEMENT DU MONITORING (Target Vertes) ---
    - name: Lancer Node Exporter
      community.docker.docker_container:
        name: node-exporter
        image: prom/node-exporter:latest
        state: started
        restart_policy: always
        published_ports: ["9100:9100"]

    - name: Lancer cAdvisor (Privilégié pour SOC)
      community.docker.docker_container:
        name: cadvisor
        image: gcr.io/cadvisor/cadvisor:latest
        state: started
        restart_policy: always
        privileged: yes
        volumes:
          - "/:/rootfs:ro"
          - "/var/run:/var/run:rw"
          - "/sys:/sys:ro"
          - "/var/lib/docker/:/var/lib/docker:ro"
        published_ports: ["8080:8080"]

    # --- 4. SECTION SÉCURITÉ : DÉTECTION HYDRA (Loki/Promtail) ---
    # Pour un vrai SOC, on surveille les tentatives de connexion échouées dans les logs
    - name: Lancer Grafana Loki (Stockage des Logs de sécurité)
      community.docker.docker_container:
        name: loki
        image: grafana/loki:latest
        state: started
        restart_policy: always
        published_ports: ["3100:3100"]

    - name: Lancer Prometheus & Grafana
      community.docker.docker_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        state: started
        restart_policy: always
        published_ports: "{{ item.port }}"
        volumes: "{{ item.volumes | default([]) }}"
      loop:
        - { name: 'prometheus', image: 'prom/prometheus:latest', port: ["9090:9090"], volumes: ["/etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml"] }
        - { name: 'grafana', image: 'grafana/grafana:latest', port: ["3000:3000"] }
